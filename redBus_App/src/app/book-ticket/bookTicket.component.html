<div class="header">
    <div (click)="dismiss()" class="close">
        <i class="fa-solid fa-angle-down fa-4x"></i>
    </div>
</div>

<div class="container" *ngIf="loaded; else loadingTemplate">
    <div class="busGraphics">
        <div class="seat-map">
            <!-- Steering Wheel on Right -->
            <div class="driverSeat">
                <img class="strWheel" [src]="steeringWheel" alt="Driver Seat">
            </div>
            <!-- Divider Below Steering Wheel -->
            <div class="divider"></div>
            <!-- Seats -->
            <div class="column-container">
                <div class="seat-column" *ngFor="let col of seats; let i = index" [ngClass]="{ 'gap-column': i === 2 }">
                    <div class="seat tooltip" *ngFor="let seat of col; let j = index" [ngClass]="seat"
                        (click)="toggleSeat(i, j)">
                        <span class="tooltiptext">{{ getSeatLabel(i, j) }}</span>
                        <!-- Optional: show label inside seat -->
                        <span class="seat-label">{{ getSeatLabel(i, j) }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="seatLegend">
            <div class="legend-header">Seat Legend</div>
            <div class="seat-type">
                <div class="seat available"></div>
                <div class="Legend">Available</div>
            </div>
            <div class="seat-type">
                <div class="seat selected"></div>
                <div class="Legend">Selected</div>
            </div>
            <div class="seat-type">
                <div class="seat booked"></div>
                <div class="Legend">Booked</div>
            </div>
        </div>
    </div>

    <div class="passenger" *ngIf="scheduleDataReceived">
        <div class="bus-card">
            <div class="bus-header">
                <div>
                    <div class="bus-title">{{scheduleDataReceived.busName}} - {{scheduleDataReceived.busVehicleNo}}
                    </div>
                    <div class="bus-subtitle">{{scheduleDataReceived.fromLocation}} --
                        {{scheduleDataReceived.toLocation}}</div>
                    <div class="bus-date">{{scheduleDataReceived.departureDateTime | date}} -
                        {{scheduleDataReceived.arrivalDateTime | date}}</div>
                </div>
                <div class="bus-rating">
                    <div class="rating-box">★&nbsp;{{scheduleDataReceived.rating}}</div>
                    <div class="rating-count">{{scheduleDataReceived.rattingCount}}</div>
                </div>
            </div>

            <div class="bus-timing">
                <div>
                    <div class="time-label">{{scheduleDataReceived.departureDateTime | date:'HH:mm a'}} — {{
                        scheduleDataReceived.arrivalDateTime
                        | date:'HH:mm a'}}</div>
                    <div class="seats-info">8h • <span>{{scheduleDataReceived.availableSeats}} Seats</span></div>
                    <div class="seats-info"><span>{{totalSelectedSeats}} Seats Selected</span></div>
                </div>
                <div class="price-info"> <br>
                    <div class="price">{{totalPrice | currency:'INR':'symbol':'1.0-0'}}</div>
                    <div class="onwards">Total Amount Payable</div>
                </div>
            </div>

            <div class="payment">
                <button type="submit" (click)="submitForm()" matTooltipClass="custom-tooltip"
                    [matTooltip]="getTooltipMessage()" [matTooltipDisabled]="!isFormInvalid()">
                    Proceed to Payment
                </button>
            </div>
        </div>
        <form #passengerForm="ngForm">
            <div class="passenger-form-container">
                <div class="card" *ngFor="let passenger of passengerForms; let i = index">
                    <h4>Passenger {{ i + 1 }} - Seat {{ passenger.seatNo }}</h4>
                    <div class="details">
                        <div class="pInfo">
                            <label>Name:</label>
                            <input type="text" [(ngModel)]="passenger.passengerName" name="name{{i}}" #nameRef="ngModel"
                                required minlength="3" />
                            <div class="error" *ngIf="nameRef.invalid && nameRef.touched">
                                <small *ngIf="nameRef.errors?.['required']">Name is required.</small>
                                <small *ngIf="nameRef.errors?.['minlength']">Name must be at least 2 characters.</small>
                            </div>
                        </div>

                        <div class="pInfo">
                            <label>Mobile No:</label>
                            <input type="tel" [(ngModel)]="passenger.mobileNo" name="mobile{{i}}" #mobileRef="ngModel"
                                required pattern="^[0-9]{10}$" />
                            <div class="error" *ngIf="mobileRef.invalid && mobileRef.touched">
                                <small *ngIf="mobileRef.errors?.['required']">Mobile number is required.</small>
                                <small *ngIf="mobileRef.errors?.['pattern']">Enter a valid 10-digit mobile
                                    number.</small>
                            </div>
                        </div>

                        <div class="pInfo">
                            <label>Age:</label>
                            <input type="number" placeholder="" [(ngModel)]="passenger.age" name="age{{i}}"
                                #ageRef="ngModel" required min="1" max="120" />
                            <div class="error" *ngIf="ageRef.invalid && ageRef.touched">
                                <small *ngIf="ageRef.errors?.['required']">Age is required.</small>
                                <small *ngIf="ageRef.errors?.['min'] || ageRef.errors?.['max']">Enter a valid age
                                    (e.g. 18 or more).</small>
                            </div>
                        </div>

                        <div class="pInfo">
                            <label>Gender:</label>
                            <select [(ngModel)]="passenger.gender" name="gender{{i}}" #genderRef="ngModel" required>
                                <option value="">Select</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                            <div class="error" *ngIf="genderRef.invalid && genderRef.touched">
                                <small *ngIf="genderRef.errors?.['required']">Gender is required.</small>
                            </div>
                        </div>

                        <div class="pInfo full-width">
                            <label>Price:</label>
                            <div class="price-display">{{passenger.price}}</div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    </div>

</div>
<ng-template #loadingTemplate>
    <div class="loading-spinner">
        <div class="background"> <span>&nbsp; </span>
            <div class="bus-body ">
                <div class="bus-body2">
                    <div class="shine"> &nbsp; </div>
                    <svg id="Layer_1" alt="bus-body" fill="#fff" viewBox="0 0 268.08 93.53">

                        <path class="cls-1"
                            d="M258,40.66V12.76a3.54,3.54,0,0,0-3.53-3.56h-240A3.55,3.55,0,0,0,11,12.76l-.41,39.8a3.55,3.55,0,0,0,3.53,3.57H31.29a3.4,3.4,0,0,0,3.23-2.33l2.31-7a3.71,3.71,0,0,1,3.53-2.56H254.5a3.54,3.54,0,0,0,3.5-3.58ZM34,45.84l-2.31,7a.41.41,0,0,1-.38.27H14.14a.55.55,0,0,1-.53-.53L14,12.76a.54.54,0,0,1,.52-.56h240a.54.54,0,0,1,.53.55h0v27.9a.54.54,0,0,1-.52.56H40.36A6.72,6.72,0,0,0,34,45.84Z"
                            transform="translate(0 0)" />
                        <path class="cls-1"
                            d="M162.63,78H75.15v1.9a5.11,5.11,0,0,0,5,5.21H168.8v-.67A6.32,6.32,0,0,0,162.63,78Z"
                            transform="translate(0 0)" />
                        <path class="cls-1"
                            d="M266.62,78V9.2A9.46,9.46,0,0,0,256.93,0H11.71A9.45,9.45,0,0,0,2,9.18v0L1.77,78H0v7.11H1.78a9.51,9.51,0,0,0,9.65,8.41h21a3,3,0,0,0,3-3h0c0-8.75,7.46-15.84,16.67-15.84s16.67,7.09,16.67,15.84h0a3,3,0,0,0,3,3H174.11A2.88,2.88,0,0,0,177,90.61v-.09h0c0-8.75,7.46-15.84,16.67-15.84,8.15,0,14.93,5.55,16.38,12.89a1.61,1.61,0,0,0,1.56,1.3h0a1.62,1.62,0,0,0,1.59-1.3,16.48,16.48,0,0,1,16.39-12.89c9.2,0,16.66,7.09,16.66,15.84h0a2.89,2.89,0,0,0,2.78,3h7.91a9.5,9.5,0,0,0,9.64-8.41h1.54V78Zm-9.69,11.52h-6.71c-.56-10.47-9.6-18.82-20.64-18.82a20.91,20.91,0,0,0-18,10,20.85,20.85,0,0,0-18-10c-11,0-20.07,8.34-20.64,18.82H72.67C72.12,79.05,63.07,70.7,52,70.7S32,79,31.39,89.52h-20A5.56,5.56,0,0,1,5.8,85.11h7.67A6.55,6.55,0,0,0,20,78.56h0V78H5.77L6,9.2A5.46,5.46,0,0,1,11.71,4H256.93a5.46,5.46,0,0,1,5.69,5.2V78h-6.87v1.74a5.36,5.36,0,0,0,5.35,5.37h1.42A5.56,5.56,0,0,1,256.93,89.52Z"
                            transform="translate(0 0)" />
                        <rect class="cls-1" x="231.69" y="55.42" width="23.02" height="2.65" />
                        <rect class="cls-1" x="231.69" y="59.65" width="23.02" height="2.65" />
                        <rect class="cls-1" x="231.69" y="64.15" width="23.02" height="2.65" />
                        <path class="cls-1" d="M43.31,64h-7.5a2.91,2.91,0,1,0-.34,5.81h7.84a2.91,2.91,0,0,0,0-5.81Z"
                            transform="translate(0 0)" />
                        <path class="cls-1" d="M43.31,57.28h-7.5a2.91,2.91,0,1,0-.34,5.81h7.84a2.91,2.91,0,0,0,0-5.81Z"
                            transform="translate(0 0)" />
                        <path class="cls-1" d="M215.54,60.26H208a2.91,2.91,0,0,0,0,5.81h7.51a2.91,2.91,0,0,0,0-5.81Z"
                            transform="translate(0 0)" />
                    </svg>
                </div>
                <div class="speed-light"></div>
                <div class="speed-light second"></div>
                <div class="shadow"></div>
                <div class="position">
                    <div class="wheel front">
                        <svg x="0px" y="0px" id="Layer_0" alt="wheel" fill="#fff" height="17" width="17"
                            viewBox="0 0 24.72 24.72">
                            <path class="cls-1"
                                d="M14,.11A12.36,12.36,0,1,0,24.6,10.75,12.36,12.36,0,0,0,14,.11Zm5.35,13.64a7.1,7.1,0,1,1,0-2.77A7.1,7.1,0,0,1,19.31,13.75Z"
                                transform="translate(0.02 0)" />
                            <circle class="cls-1" cx="9.04" cy="10.23" r="1.11" />
                            <circle class="cls-1" cx="8.87" cy="14.18" r="1.11" />
                            <circle class="cls-1" cx="12.2" cy="16.3" r="1.11" />
                            <circle class="cls-1" cx="15.71" cy="14.47" r="1.11" />
                            <circle class="cls-1" cx="15.87" cy="10.53" r="1.11" />
                            <circle class="cls-1" cx="12.54" cy="8.41" r="1.11" />
                        </svg>
                    </div>
                    <div class="wheel back">
                        <svg x="0px" y="0px" id="Layer_2" alt="wheel" fill="#fff" height="17" width="17"
                            viewBox="0 0 24.72 24.72">
                            <path class="cls-1"
                                d="M14,.11A12.36,12.36,0,1,0,24.6,10.75,12.36,12.36,0,0,0,14,.11Zm5.35,13.64a7.1,7.1,0,1,1,0-2.77A7.1,7.1,0,0,1,19.31,13.75Z"
                                transform="translate(0.02 0)" />
                            <circle class="cls-1" cx="9.04" cy="10.23" r="1.11" />
                            <circle class="cls-1" cx="8.87" cy="14.18" r="1.11" />
                            <circle class="cls-1" cx="12.2" cy="16.3" r="1.11" />
                            <circle class="cls-1" cx="15.71" cy="14.47" r="1.11" />
                            <circle class="cls-1" cx="15.87" cy="10.53" r="1.11" />
                            <circle class="cls-1" cx="12.54" cy="8.41" r="1.11" />
                        </svg>
                    </div>
                    <div class="wheel back2">
                        <svg x="0px" y="0px" id="Layer_3" alt="wheel" fill="#fff" height="17" width="17"
                            viewBox="0 0 24.72 24.72">
                            <path class="cls-1"
                                d="M14,.11A12.36,12.36,0,1,0,24.6,10.75,12.36,12.36,0,0,0,14,.11Zm5.35,13.64a7.1,7.1,0,1,1,0-2.77A7.1,7.1,0,0,1,19.31,13.75Z"
                                transform="translate(0.02 0)" />
                            <circle class="cls-1" cx="9.04" cy="10.23" r="1.11" />
                            <circle class="cls-1" cx="8.87" cy="14.18" r="1.11" />
                            <circle class="cls-1" cx="12.2" cy="16.3" r="1.11" />
                            <circle class="cls-1" cx="15.71" cy="14.47" r="1.11" />
                            <circle class="cls-1" cx="15.87" cy="10.53" r="1.11" />
                            <circle class="cls-1" cx="12.54" cy="8.41" r="1.11" />
                        </svg>
                    </div>
                </div>
            </div>
            <div class="loader"> <span>L</span> <span>O</span> <span>A</span> <span>D</span> <span>I</span>
                <span>N</span> <span>G</span> </div>
        </div>
    </div>
</ng-template>