<div class="bus" *ngIf="loaded; else loading">
    <div class="addBusSchedule">
        <h1>Add New Schedule</h1>
        <div class="divider"></div>
        <form (ngSubmit)="submitSchedule(scheduleForm)" #scheduleForm="ngForm" class="schedule-form">
            <div class="row">
                <label>Select Your Bus</label>
                <input type="text" name="busName" required #busNameModel="ngModel"
                    [class.invalid]="busNameModel.invalid && busNameModel.touched"
                    (keydown)="handleBusesKeyDown($event)" [(ngModel)]="scheduleToSubmit.busName"
                    (focus)="onFocusBuses()" (input)="filterBuses()" (blur)="onBlurBuses()"
                    placeholder="Select bus to schedule" />
            </div>

            <!-- <div class="row">
                <label>From Location</label>
                <input type="text" name="fromLocation"  (keydown)="handleFromKeyDown($event)" [(ngModel)]="fromLocation"
                    (focus)="onFocusFromLocation()" (input)="filterFromLocations()" (blur)="onBlurFromLocation()"
                    placeholder="Enter City or station" />
            </div> -->

            <div class="row">
                <label>From Location</label>
                <input type="text" name="fromLocation" required #fromLocationInput="ngModel" [(ngModel)]="fromLocation"
                    (keydown)="handleFromKeyDown($event)" (focus)="onFocusFromLocation()"
                    (input)="filterFromLocations()" (blur)="onBlurFromLocation()" placeholder="Enter City or station"
                    [class.invalid]="fromLocationInput.invalid && fromLocationInput.touched" />
            </div>


            <div class="row">
                <label>To Location</label>
                <input type="text" name="toLocation" required #toLocationInput="ngModel"
                    [class.invalid]="toLocationInput.invalid && toLocationInput.touched"
                    (keydown)="handleToKeyDown($event)" [(ngModel)]="toLocation" (focus)="onFocusToLocation()"
                    (input)="filterToLocations()" (blur)="onBlurToLocation()" placeholder="Enter City or station" />
            </div>

            <div class="row" #dCalendarRef>
                <label>Departure Date</label>
                <input type="text" class="datePickerToggle" required #departureDateModel="ngModel"
                    [class.invalid]="departureDateModel.invalid && departureDateModel.touched" readonly
                    placeholder="e.g. June 25" [value]="selectedDDate ? getFormattedDate(selectedDDate) : inputDate"
                    (click)="toggleDeptCalendar()" [(ngModel)]="departureDate" name="departureDateTime" required />
            </div>


            <div class="row" #departureTimePickerRef>
                <label>Departure Time</label>
                <input type="time" [(ngModel)]="departureTime" required #departureTimeModel="ngModel"
                    [class.invalid]="departureTimeModel.invalid && departureTimeModel.touched"
                    (click)="showDepartureTimePicker = !showDepartureTimePicker" (input)="onDepartureTimeInputChange()"
                    name="departureTime" required />
            </div>

            <div class="row" #aCalendarRef>
                <label>Arrival Date</label>
                <input type="text" required #arrivalDateModel="ngModel"
                    [class.invalid]="arrivalDateModel.invalid && arrivalDateModel.touched" class="datePickerToggle"
                    readonly placeholder="e.g. June 26"
                    [value]="selectedADate ? getFormattedDate(selectedADate) : inputDate" (click)="toggleArivCalendar()"
                    [(ngModel)]="arrivalDate" name="arrivalDateTime" required />
            </div>

            <div class="row" #arrivalTimePickerRef>
                <label>Arrival Time</label>
                <input type="time" required #arrivalTimeModel="ngModel"
                    [class.invalid]="arrivalTimeModel.invalid && arrivalTimeModel.touched" [(ngModel)]="arrivalTime"
                    (click)="showArrivalTimePicker = !showArrivalTimePicker" (input)="onArrivalTimeInputChange()"
                    name="arrivalTime" required />

            </div>

            <div class="row">
                <label>Price per Seat</label>
                <input type="number" [(ngModel)]="scheduleToSubmit.pricePerSeat" required #pricePerSeatModel="ngModel"
                    [class.invalid]="pricePerSeatModel.invalid && pricePerSeatModel.touched" name="pricePerSeat"
                    placeholder="e.g. 1200" min="1" required />
            </div>

            <!-- Optional: Schedule status -->

            <div class="row">
                <label>Status</label>
                <input type="text" required #statusModel="ngModel"
                    [class.invalid]="statusModel.invalid && statusModel.touched" name="statusSuggestion"
                    (keydown)="handleStatusKeyDown($event)" [(ngModel)]="selectedStatus" (focus)="onFocusStatus()"
                    (blur)="onBlurStautsSuggestion()" placeholder="e.g. Active" />
            </div>


            <button type="submit">Create Schedule</button>
        </form>


        <!-- TIME PICKER DROPDOWN -->
        <div class="timeD-picker-dropdown" *ngIf="showDepartureTimePicker">
            <div class="timeD-picker-content">
                <div class="time-column">
                    <button (click)="increaseDHour()">▲</button>
                    <div class="status-dropdown-name">{{ displayDHour }}</div>
                    <button (click)="decreaseDHour()">▼</button>
                </div>

                <div class="colon">:</div>

                <div class="time-column">
                    <button (click)="increaseDMinute()">▲</button>
                    <div class="status-dropdown-name">{{ dMinute.toString().padStart(2, '0') }}</div>
                    <button (click)="decreaseDMinute()">▼</button>
                </div>

                <div class="time-column">
                    <button (click)="toggleDMeridian()">▲</button>
                    <div class="status-dropdown-name">{{ dMeridian }}</div>
                    <button (click)="toggleDMeridian()">▼</button>
                </div>
            </div>
        </div>

        <div #test>
            <div class="timeA-picker-dropdown" *ngIf="showArrivalTimePicker">
                <div class="timeA-picker-content">
                    <div class="time-column">
                        <button (click)="increaseAHour()">▲</button>
                        <div class="status-dropdown-name">{{ displayAHour }}</div>
                        <button (click)="decreaseAHour()">▼</button>
                    </div>
                    <div class="colon">:</div>
                    <div class="time-column">
                        <button (click)="increaseAMinute()">▲</button>
                        <div class="status-dropdown-name">{{ minute.toString().padStart(2, '0') }}</div>
                        <button (click)="decreaseAMinute()">▼</button>
                    </div>
                    <div class="time-column">
                        <button (click)="toggleAMeridian()">▲</button>
                        <div class="status-dropdown-name">{{ meridian }}</div>
                        <button (click)="toggleAMeridian()">▼</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Suggestion Dropdown For Buses -->
        <div class="buses-dropdown" *ngIf="showBusesSuggestions && buses.length > 0">
            <div *ngFor="let bus of buses; let i = index" [class.highlighted]="i === busFocusedIndex"
                (mousedown)="selectBus(bus)" class="buses-dropdown-item">
                <span class="buses-dropdown-icon">
                    <i class="fa-solid fa-bus-simple buses-dropdown-img"></i>
                </span>

                <div class="buses-dropdown-text">
                    <span class="buses-dropdown-name">{{ bus.busName }}</span>
                    <span class="buses-dropdown-sub">{{ bus.busVehicleNo }}</span>
                    <!-- <span *ngIf="location.locationSub" class="from-dropdown-sub">{{ location.locationSub }}</span> -->
                </div>
            </div>
        </div>

        <!-- ----------------------------- -->

        <!-- Suggestion Dropdown For From-Location -->
        <div class="from-dropdown" *ngIf="showFromSuggestions && filteredFromLocations.length > 0">
            <div *ngFor="let location of filteredFromLocations; let i = index"
                [class.highlighted]="i === fromFocusedIndex" (mousedown)="selectFromLocation(location)"
                class="from-dropdown-item">
                <span class="from-dropdown-icon">
                    <img [src]="location.locationType === 'Urban' ? urbanLocation : locationPin" alt="location"
                        class="from-dropdown-img">
                </span>

                <div class="from-dropdown-text">
                    <span class="from-dropdown-name">{{ location.locationName }}</span>
                    <span *ngIf="location.locationSub" class="from-dropdown-sub">{{ location.locationSub }}</span>
                </div>
            </div>
        </div>

        <!-- ----------------------------- -->

        <!-- Suggestion Dropdown For To Location -->
        <div class="to-dropdown" *ngIf="showToSuggestions && filteredToLocations.length > 0">
            <div *ngFor="let location of filteredToLocations; let i = index" [class.highlighted]="i === toFocusedIndex"
                (mousedown)="selectToLocation(location)" class="to-dropdown-item">
                <span class="to-dropdown-icon">
                    <img [src]="location.locationType === 'urban' ? urbanLocation : locationPin" alt="location"
                        class="to-dropdown-img">
                </span>

                <div class="to-dropdown-text">
                    <span class="to-dropdown-name">{{ location.locationName }}</span>
                    <span *ngIf="location.locationSub" class="to-dropdown-sub">{{ location.locationSub }}</span>
                </div>
            </div>
        </div>
        <!-- ----------------------------- -->

        <!-- Suggestion Dropdown For To Status -->
        <div class="status-dropdown" *ngIf="showStatus && statusSuggestions.length > 0">
            <div *ngFor="let status of statusSuggestions; let i = index" [class.highlighted]="i === statusFocusedIndex"
                (mousedown)="selectStatusSuggestion(status)" class="status-dropdown-item">

                <div class="status-dropdown-text">
                    <span class="status-dropdown-name">{{ status }}</span>
                </div>
            </div>
        </div>
        <!-- ----------------------------- -->



        <!-- Dept Date Picker -->
        <div class="datePickerToggle date-picker" *ngIf="deptCalendarOpen">

            <!-- Month Header -->
            <div class="month-header">
                <button (click)="previousMonth()" [disabled]="isAtInitialMonth()" class="left-arrow"
                    [style.color]="isAtInitialMonth()? '#ccc':'#000'">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <span>{{ formattedMonth }}</span>
                <button (click)="nextMonth()" class="right-arrow">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>

            <!-- Days of the Week -->
            <div class="week-days">
                <span *ngFor="let day of weekDays">{{ day }}</span>
            </div>

            <!-- Dates Grid -->
            <div class="dates-grid">
                <ng-container *ngFor="let date of datesInMonth">
                    <span *ngIf="date !== null; else emptyCell" [style.color]="
                  isSelectedDDate(date)
                    ? 'red'
                    : isToday(date)
                    ? '#fff'
                    : isPastDate(date)
                    ? '#ccc'
                    : '#000'
                " [style.background]="isToday(date) ? '#222' : 'transparent'"
                        [style.pointerEvents]="isPastDate(date) ? 'none' : 'auto'" class="date-cell"
                        (click)="!isPastDate(date) && selectDDate(date)">
                        {{ getDateValue(date) }}
                    </span>

                    <ng-template #emptyCell>
                        <span class="empty-cell"></span>
                    </ng-template>
                </ng-container>
            </div>



        </div>


        <!-- Ariv Date Picker -->
        <div class="arivDatePickerToggle date-picker" *ngIf="arivCalendarOpen">

            <!-- Month Header -->
            <div class="month-header">
                <button (click)="previousMonth()" [disabled]="isAtInitialMonth()" class="left-arrow"
                    [style.color]="isAtInitialMonth()? '#ccc':'#000'">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <span>{{ formattedMonth }}</span>
                <button (click)="nextMonth()" class="right-arrow">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>

            <!-- Days of the Week -->
            <div class="week-days">
                <span *ngFor="let day of weekDays">{{ day }}</span>
            </div>

            <!-- Dates Grid -->
            <div class="dates-grid">
                <ng-container *ngFor="let date of datesInMonth">
                    <span *ngIf="date !== null; else emptyCell" [style.color]="
                  isSelectedADate(date)
                    ? 'red'
                    : isToday(date)
                    ? '#fff'
                    : isPastDate(date)
                    ? '#ccc'
                    : '#000'
                " [style.background]="isToday(date) ? '#222' : 'transparent'"
                        [style.pointerEvents]="isPastDate(date) ? 'none' : 'auto'" class="date-cell"
                        (click)="!isPastDate(date) && selectADate(date)">
                        {{ getDateValue(date) }}
                    </span>

                    <ng-template #emptyCell>
                        <span class="empty-cell"></span>
                    </ng-template>
                </ng-container>
            </div>



        </div>









    </div>


    <div class="listOfActiveSchedule">
        <h1>Upcoming Schedules</h1>
        <div class="divider"></div>



        <div class="tableContainer" *ngIf="schedules.length > 0; else noSchedules">
            <table class="scheduleTable">
                <thead>
                    <tr>
                        <th class="firstTH">Schedule ID</th>
                        <th>Bus Name</th>
                        <th>Vehicle No</th>
                        <th>AC</th>
                        <th>Bus Type</th>
                        <th>Capacity</th>
                        <th>Available</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Departure</th>
                        <th>Arrival</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th class="lastTH">Preference</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let schedule of schedules; let i = index" [ngClass]="{ 'even-row': i % 2 === 1 }">
                        <td>{{ schedule.scheduleId }}</td>
                        <td>{{ schedule.busName }}</td>
                        <td>{{ schedule.busVehicleNo }}</td>
                        <td>{{ schedule.isAC ? 'Yes' : 'No' }}</td>
                        <td>{{ schedule.busType }}</td>
                        <td>{{ schedule.totalSeats }} Seats</td>
                        <td>{{ schedule.availableSeats }} Seats</td>
                        <td>{{ schedule.fromLocation }}</td>
                        <td>{{ schedule.toLocation }}</td>
                        <td>{{ schedule.departureDateTime | date:'dd/MM/yyyy, h:mm a' }}</td>
                        <td>{{ schedule.arrivalDateTime | date:'dd/MM/yyyy, h:mm a' }}</td>
                        <td>{{ schedule.pricePerSeat | currency:'INR':'symbol':'1.0-0' }}</td>
                        <td>{{ schedule.scheduleStatus }}</td>
                        <td class="prefTD">
                            <div class="dropdown-wrapper" #dropdownWrapper>
                                <i class="fa-solid fa-bars currentStatus-bus"
                                    (click)="toggleDropdown(schedule.scheduleId)"></i>

                                <ul class="dropdown-menu" *ngIf="openDropdownId === schedule.scheduleId">
                                    <li
                                        (click)="schedule.scheduleStatus == 'Active'?
                                     scheduleVisibility(schedule,'Inactivate'):scheduleVisibility(schedule,'Activate')">
                                        {{schedule.scheduleStatus =="Active"?
                                        "Inactive" : "Active"}}</li>
                                    <li (click)="viewBookingDetails(schedule)">Booking Details</li>
                                </ul>
                            </div>

                            <i class="fa-solid fa-trash-can delete-bus"
                                (click)="deleteSchedule(schedule.scheduleId)"></i>
                        </td>

                    </tr>
                </tbody>
            </table>

            <div class="paginationContainer" *ngIf="totalPages>1">
                <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">&lt;</button>

                <button *ngFor="let page of pages" (click)="goToPage(page)" [class.active]="page === currentPage">
                    {{ page }}
                </button>

                <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">&gt;</button>
            </div>
        </div>

        <ng-template #noSchedules>
            <h3 class="no-data">No schedules found for your buses. If you have any schedule then it will load shortly.
            </h3>
        </ng-template>


    </div>


</div>





<ng-template #loading>
    <div class="loading-spinner">
        <div class="background"> <span>&nbsp; </span>
            <div class="bus-body ">
                <div class="bus-body2">
                    <div class="shine"> &nbsp; </div>
                    <svg id="Layer_1" alt="bus-body" fill="#fff" viewBox="0 0 268.08 93.53">

                        <path class="cls-1"
                            d="M258,40.66V12.76a3.54,3.54,0,0,0-3.53-3.56h-240A3.55,3.55,0,0,0,11,12.76l-.41,39.8a3.55,3.55,0,0,0,3.53,3.57H31.29a3.4,3.4,0,0,0,3.23-2.33l2.31-7a3.71,3.71,0,0,1,3.53-2.56H254.5a3.54,3.54,0,0,0,3.5-3.58ZM34,45.84l-2.31,7a.41.41,0,0,1-.38.27H14.14a.55.55,0,0,1-.53-.53L14,12.76a.54.54,0,0,1,.52-.56h240a.54.54,0,0,1,.53.55h0v27.9a.54.54,0,0,1-.52.56H40.36A6.72,6.72,0,0,0,34,45.84Z"
                            transform="translate(0 0)" />
                        <path class="cls-1"
                            d="M162.63,78H75.15v1.9a5.11,5.11,0,0,0,5,5.21H168.8v-.67A6.32,6.32,0,0,0,162.63,78Z"
                            transform="translate(0 0)" />
                        <path class="cls-1"
                            d="M266.62,78V9.2A9.46,9.46,0,0,0,256.93,0H11.71A9.45,9.45,0,0,0,2,9.18v0L1.77,78H0v7.11H1.78a9.51,9.51,0,0,0,9.65,8.41h21a3,3,0,0,0,3-3h0c0-8.75,7.46-15.84,16.67-15.84s16.67,7.09,16.67,15.84h0a3,3,0,0,0,3,3H174.11A2.88,2.88,0,0,0,177,90.61v-.09h0c0-8.75,7.46-15.84,16.67-15.84,8.15,0,14.93,5.55,16.38,12.89a1.61,1.61,0,0,0,1.56,1.3h0a1.62,1.62,0,0,0,1.59-1.3,16.48,16.48,0,0,1,16.39-12.89c9.2,0,16.66,7.09,16.66,15.84h0a2.89,2.89,0,0,0,2.78,3h7.91a9.5,9.5,0,0,0,9.64-8.41h1.54V78Zm-9.69,11.52h-6.71c-.56-10.47-9.6-18.82-20.64-18.82a20.91,20.91,0,0,0-18,10,20.85,20.85,0,0,0-18-10c-11,0-20.07,8.34-20.64,18.82H72.67C72.12,79.05,63.07,70.7,52,70.7S32,79,31.39,89.52h-20A5.56,5.56,0,0,1,5.8,85.11h7.67A6.55,6.55,0,0,0,20,78.56h0V78H5.77L6,9.2A5.46,5.46,0,0,1,11.71,4H256.93a5.46,5.46,0,0,1,5.69,5.2V78h-6.87v1.74a5.36,5.36,0,0,0,5.35,5.37h1.42A5.56,5.56,0,0,1,256.93,89.52Z"
                            transform="translate(0 0)" />
                        <rect class="cls-1" x="231.69" y="55.42" width="23.02" height="2.65" />
                        <rect class="cls-1" x="231.69" y="59.65" width="23.02" height="2.65" />
                        <rect class="cls-1" x="231.69" y="64.15" width="23.02" height="2.65" />
                        <path class="cls-1" d="M43.31,64h-7.5a2.91,2.91,0,1,0-.34,5.81h7.84a2.91,2.91,0,0,0,0-5.81Z"
                            transform="translate(0 0)" />
                        <path class="cls-1" d="M43.31,57.28h-7.5a2.91,2.91,0,1,0-.34,5.81h7.84a2.91,2.91,0,0,0,0-5.81Z"
                            transform="translate(0 0)" />
                        <path class="cls-1" d="M215.54,60.26H208a2.91,2.91,0,0,0,0,5.81h7.51a2.91,2.91,0,0,0,0-5.81Z"
                            transform="translate(0 0)" />
                    </svg>
                </div>
                <div class="speed-light"></div>
                <div class="speed-light second"></div>
                <div class="shadow"></div>
                <div class="position">
                    <div class="wheel front">
                        <svg x="0px" y="0px" id="Layer_0" alt="wheel" fill="#fff" height="17" width="17"
                            viewBox="0 0 24.72 24.72">
                            <path class="cls-1"
                                d="M14,.11A12.36,12.36,0,1,0,24.6,10.75,12.36,12.36,0,0,0,14,.11Zm5.35,13.64a7.1,7.1,0,1,1,0-2.77A7.1,7.1,0,0,1,19.31,13.75Z"
                                transform="translate(0.02 0)" />
                            <circle class="cls-1" cx="9.04" cy="10.23" r="1.11" />
                            <circle class="cls-1" cx="8.87" cy="14.18" r="1.11" />
                            <circle class="cls-1" cx="12.2" cy="16.3" r="1.11" />
                            <circle class="cls-1" cx="15.71" cy="14.47" r="1.11" />
                            <circle class="cls-1" cx="15.87" cy="10.53" r="1.11" />
                            <circle class="cls-1" cx="12.54" cy="8.41" r="1.11" />
                        </svg>
                    </div>
                    <div class="wheel back">
                        <svg x="0px" y="0px" id="Layer_2" alt="wheel" fill="#fff" height="17" width="17"
                            viewBox="0 0 24.72 24.72">
                            <path class="cls-1"
                                d="M14,.11A12.36,12.36,0,1,0,24.6,10.75,12.36,12.36,0,0,0,14,.11Zm5.35,13.64a7.1,7.1,0,1,1,0-2.77A7.1,7.1,0,0,1,19.31,13.75Z"
                                transform="translate(0.02 0)" />
                            <circle class="cls-1" cx="9.04" cy="10.23" r="1.11" />
                            <circle class="cls-1" cx="8.87" cy="14.18" r="1.11" />
                            <circle class="cls-1" cx="12.2" cy="16.3" r="1.11" />
                            <circle class="cls-1" cx="15.71" cy="14.47" r="1.11" />
                            <circle class="cls-1" cx="15.87" cy="10.53" r="1.11" />
                            <circle class="cls-1" cx="12.54" cy="8.41" r="1.11" />
                        </svg>
                    </div>
                    <div class="wheel back2">
                        <svg x="0px" y="0px" id="Layer_3" alt="wheel" fill="#fff" height="17" width="17"
                            viewBox="0 0 24.72 24.72">
                            <path class="cls-1"
                                d="M14,.11A12.36,12.36,0,1,0,24.6,10.75,12.36,12.36,0,0,0,14,.11Zm5.35,13.64a7.1,7.1,0,1,1,0-2.77A7.1,7.1,0,0,1,19.31,13.75Z"
                                transform="translate(0.02 0)" />
                            <circle class="cls-1" cx="9.04" cy="10.23" r="1.11" />
                            <circle class="cls-1" cx="8.87" cy="14.18" r="1.11" />
                            <circle class="cls-1" cx="12.2" cy="16.3" r="1.11" />
                            <circle class="cls-1" cx="15.71" cy="14.47" r="1.11" />
                            <circle class="cls-1" cx="15.87" cy="10.53" r="1.11" />
                            <circle class="cls-1" cx="12.54" cy="8.41" r="1.11" />
                        </svg>
                    </div>
                </div>
            </div>
            <div class="loader"> <span>L</span> <span>O</span> <span>A</span> <span>D</span> <span>I</span>
                <span>N</span> <span>G</span>
            </div>
        </div>
    </div>
</ng-template>